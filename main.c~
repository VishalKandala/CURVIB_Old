#include "variables.h"

static char help[] = "Testing programming!";

PetscInt ti,tistart=0;
PetscReal	Flux_in = 4.104388e-04, angle = 0;
PetscInt tiout = 10;
PetscInt block_number;
PetscReal FluxInSum, FluxOutSum;
/* immeresed value>1 determines the type of correction
   1      constant velocity correction
   2      proportional (needs FluxOutSum>0)
   3      proportional to flux
   4      proportional to normal velocity (flux/area)
*/
PetscInt immersed = 0; 
PetscInt invicid = 0;
PetscInt movefsi = 0, rotatefsi=0, sediment=0;
PetscBool rstart_flg;
PetscInt implicit = 0, implicit_type=0;
PetscInt imp_MAX_IT = 50; 
PetscInt radi=10;
PetscInt inletprofile=2, InitialGuessOne=0, period=0;
PetscReal CMx_c=0., CMy_c=0., CMz_c=0.;
PetscInt  mg_MAX_IT=30, mg_idx=1, mg_preItr=1, mg_poItr=1;
PetscReal imp_atol=1e-7, imp_rtol=1e-4, imp_stol=1.e-8;
PetscInt TwoD = 0;
PetscInt STRONG_COUPLING=0;
PetscInt rstart_fsi=0;
PetscInt cop=0, regime=1; // 1 escape regime --- 2 cruise regime
PetscInt fish=0, fish_c=0, eel=0, fishcyl=0, rheology=0,duplicate=0,turbine=0,Pipe=0,pizza=0;
PetscInt wing=0, hydro=0;
PetscReal St_exp=0.5,wavelength=0.95;
PetscInt MHV=0,LV=0, BHV=0, beam=0, inv_flg=0;
PetscReal max_angle = -0.87266;// depends on the initial angle 
PetscInt thin=0;
PetscInt dgf_z=0,dgf_y=1,dgf_x=0;
PetscInt dgf_az=0,dgf_ay=0,dgf_ax=1 ;
PetscInt NumberOfBodies=1;
PetscInt moveframe=0,rotateframe=0, blank=0;
PetscReal L_dim;
PetscInt les=0, rans=0, channelz=0;
PetscInt wallfunction=0;
PetscInt averaging=0;
PetscInt phave=0;
int mixed=0;
int clark=0;
int dynamic_freq=1;
int poisson=0;
int periodic=0;
PetscReal max_cs=0.5;
int grid1d=0;
int i_periodic=0;
int j_periodic=0;
int k_periodic=0;
PetscInt blkpbc=10;
int pseudo_periodic=0;
int testfilter_ik=0;
int testfilter_1d=0;
int i_homo_filter=0;
int j_homo_filter=0;
int k_homo_filter=0;
double poisson_tol=5.e-9;	// relative tolerance

//S-----------------fem variables------------------------------------------------
PetscReal  E=0.0, mu=0.0, rho=0.0, h0=0.0, dampfactor=0.0;
PetscInt   dof=3, twod=0, damping=0, membrane=0, bending=0, outghost=0, ConstitutiveLawNonLinear=0;
PetscInt   nbody=1, timeinteg=0, contact=0, explicit=0, initrest=0, innerloop=1, rstart_fem=0;
//E-----------------fem variables------------------------------------------------

double time_flow[3000],flux_flow[3000];
//IBMNodes	*ibm_ptr;
double PI = 3.141592653589793;

PetscErrorCode Ucont_P_Binary_Input(UserCtx *user)
{

  PetscViewer	viewer;

  char filen[90];

  
  sprintf(filen, "vfield%5.5d_%1.1d.dat", ti, user->_this);

  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
  PetscInt N;

  VecGetSize(user->Ucont, &N);
  PetscPrintf(PETSC_COMM_WORLD, "PPP %d\n", N);
  VecLoad((user->Ucont),viewer);
  
  PetscViewerDestroy(&viewer);

  PetscBarrier(PETSC_NULL);

  PetscOptionsClearValue("-vecload_block_size");

  sprintf(filen, "pfield%5.5d_%1.1d.dat", ti, user->_this);

  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
  VecLoad((user->P),viewer);
  PetscViewerDestroy(&viewer);

  sprintf(filen, "nvfield%5.5d_%1.1d.dat", ti, user->_this);

  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
  VecLoad((user->Nvert_o),viewer);
  PetscViewerDestroy(&viewer);

  DMGlobalToLocalBegin(user->da, user->Nvert_o, INSERT_VALUES, user->lNvert_o);
  DMGlobalToLocalEnd(user->da, user->Nvert_o, INSERT_VALUES, user->lNvert_o);

  if(averaging) {	// Seokkoo Kang
    sprintf(filen, "su0_%06d_%1d.dat",ti, user->_this);
    FILE *fp=fopen(filen, "r");
    
    VecSet(user->Ucat_sum, 0);
    VecSet(user->Ucat_cross_sum, 0);
    VecSet(user->Ucat_square_sum, 0);
    VecSet(user->P_sum, 0);
    VecSet(user->lUstar_sum, 0);

 

    if(fp==NULL) {
      PetscPrintf(PETSC_COMM_WORLD,"\n\n*** Cannot open %s, setting the statistical quantities to zero and contiues the computation ... ***\n\n", filen);
    }
    else {
      PetscOptionsClearValue("-vecload_block_size");
      fclose(fp);
      PetscBarrier(PETSC_NULL);
      sprintf(filen, "su0_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->Ucat_sum,viewer);
      PetscViewerDestroy(&viewer);
      
      sprintf(filen, "su1_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad(user->Ucat_cross_sum,viewer);
      PetscViewerDestroy(&viewer);
      
      sprintf(filen, "su2_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad((user->Ucat_square_sum),viewer);
      PetscViewerDestroy(&viewer);
      
      sprintf(filen, "sp_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->P_sum,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "sustar_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->lUstar_sum,viewer);
      PetscViewerDestroy(&viewer);

      PetscPrintf(PETSC_COMM_WORLD,"\n\n*** Read %s, continuing averaging ... ***\n\n", filen);
    }
  }


    if(averaging && phave) {	// Amir
    sprintf(filen, "suph0_%06d_%1d.dat",ti, user->_this);
    FILE *fp=fopen(filen, "r");

     VecSet(user->Ucat_sum0, 0); 
     VecSet(user->Ucat_sum1, 0);
     VecSet(user->Ucat_sum2, 0); 
     VecSet(user->Ucat_sum3, 0);
     VecSet(user->P_sum0, 0);
     VecSet(user->P_sum1, 0);
     VecSet(user->P_sum2, 0);
     VecSet(user->P_sum3, 0);
 //   } 

     if(fp==NULL) {
      PetscPrintf(PETSC_COMM_WORLD,"\n\n*** Cannot open %s, setting the statistical quantities to zero and contiues the computation ... ***\n\n", filen);
    }
    else {
      PetscOptionsClearValue("-vecload_block_size");
      fclose(fp);
      PetscBarrier(PETSC_NULL);
      
      sprintf(filen, "suph0_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->Ucat_sum0,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "suph1_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->Ucat_sum1,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "suph2_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->Ucat_sum2,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "suph3_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->Ucat_sum3,viewer);
      PetscViewerDestroy(&viewer);

      sprintf(filen, "spph0_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->P_sum0,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "spph1_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->P_sum1,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "spph2_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->P_sum2,viewer);
      PetscViewerDestroy(&viewer);
 
      sprintf(filen, "spph3_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( user->P_sum3,viewer);
      PetscViewerDestroy(&viewer);
     // }

      PetscPrintf(PETSC_COMM_WORLD,"\n\n*** Read %s, continuing averaging ... ***\n\n", filen);
    }
  }
 

  
  if(les) {
    Vec Cs;
    
    VecDuplicate(user->P, &Cs);
    
    sprintf(filen, "cs_%06d_%1d.dat", ti, user->_this);
    FILE *fp=fopen(filen, "r");
    
    if(fp==NULL) {
      PetscPrintf(PETSC_COMM_WORLD,"\n\n*** Cannot open %s, setting Cs to 0 and contiues the computation ... ***\n\n", filen);
      VecSet(Cs, 0);
    }
    else {
      fclose(fp);
      
      PetscBarrier(PETSC_NULL);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad( Cs,viewer);
      PetscViewerDestroy(&viewer);
    }
    
    DMGlobalToLocalBegin(user->da, Cs, INSERT_VALUES, user->lCs);
    DMGlobalToLocalEnd(user->da, Cs, INSERT_VALUES, user->lCs);
    
    VecDestroy(&Cs);
  }

  
   if(rans) {
    // K-Omega
    sprintf(filen, "kfield%06d_%1d.dat", ti, user->_this);
    FILE *fp=fopen(filen, "r");
    
    if(fp!=NULL) {
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_READ, &viewer);
      VecLoad(user->K_Omega,viewer);
      PetscViewerDestroy(&viewer);
    }
    else {
      K_Omega_IC(user);
    }
    
    VecCopy(user->K_Omega, user->K_Omega_o);
    
    DMGlobalToLocalBegin(user->fda2, user->K_Omega, INSERT_VALUES, user->lK_Omega);
    DMGlobalToLocalEnd(user->fda2, user->K_Omega, INSERT_VALUES, user->lK_Omega);
    
    DMGlobalToLocalBegin(user->fda2, user->K_Omega_o, INSERT_VALUES, user->lK_Omega_o);
    DMGlobalToLocalEnd(user->fda2, user->K_Omega_o, INSERT_VALUES, user->lK_Omega_o);    
  }

  return 0;
}

PetscErrorCode Ucont_P_Binary_Output(UserCtx *user)
{
  PetscViewer	viewer;
  char filen[80];

  int rank;
  
  MPI_Comm_rank(PETSC_COMM_WORLD, &rank);
 

  sprintf(filen, "nvfield%5.5d_%1.1d.dat", ti, user->_this);

  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
  
  VecView(user->Nvert, viewer);
  PetscViewerDestroy(&viewer);
 

   PetscBarrier(PETSC_NULL);

 
  sprintf(filen, "vfield%5.5d_%1.1d.dat", ti, user->_this);
  
  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
  
  VecView(user->Ucont, viewer);
  
  PetscViewerDestroy(&viewer);
  
  
  sprintf(filen, "ufield%5.5d_%1.1d.dat", ti, user->_this);
  
  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
  
  VecView(user->Ucat, viewer);
  
  PetscViewerDestroy(&viewer);
  
  sprintf(filen, "pfield%5.5d_%1.1d.dat", ti, user->_this);
  
  PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
  
  VecView(user->P, viewer);
  PetscViewerDestroy(&viewer);
   
  if(averaging && ti!=0) {	// Seokkoo Kang
    sprintf(filen, "su0_%06d_%1d.dat", ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(user->Ucat_sum, viewer);
    PetscViewerDestroy(&viewer);
    sprintf(filen, "su0_%06d_%1d.dat.info", ti, user->_this);	if(!rank) unlink(filen);
    
   PetscBarrier(PETSC_NULL);
    
    sprintf(filen, "su1_%06d_%1d.dat",  ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(user->Ucat_cross_sum, viewer);
    PetscViewerDestroy(&viewer);  
    sprintf(filen, "su1_%06d_%1d.dat.info", ti, user->_this);	if(!rank) unlink(filen);
    
    PetscBarrier(PETSC_NULL);
    
    sprintf(filen, "su2_%06d_%1d.dat", ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(user->Ucat_square_sum, viewer);
    PetscViewerDestroy(&viewer);
    sprintf(filen, "su2_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
    
    PetscBarrier(PETSC_NULL);
    
    sprintf(filen, "sp_%06d_%1d.dat",ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(user->P_sum, viewer);
    PetscViewerDestroy(&viewer);
    sprintf(filen, "sp_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
   
    sprintf(filen, "sustar_%06d_%1d.dat",ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(user->lUstar_sum, viewer);
    PetscViewerDestroy(&viewer);
    sprintf(filen, "sustar_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
       
    PetscBarrier(PETSC_NULL);

  if (phave){
      sprintf(filen, "suph0_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->Ucat_sum0, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "suph0_%06d_%1d.dat.info", ti, user->_this);	if(!rank) unlink(filen);
   
       PetscBarrier(PETSC_NULL);
 
      sprintf(filen, "suph1_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView( user->Ucat_sum1,viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "suph1_%06d_%1d.dat.info", ti, user->_this);	if(!rank) unlink(filen);

        PetscBarrier(PETSC_NULL);
 
      sprintf(filen, "suph2_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->Ucat_sum2, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "suph2_%06d_%1d.dat.info", ti, user->_this);	if(!rank) unlink(filen);
   
      PetscBarrier(PETSC_NULL);
 
      sprintf(filen, "suph3_%06d_%1d.dat", ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->Ucat_sum3, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "suph3_%06d_%1d.dat.info", ti, user->_this);	if(!rank) unlink(filen);
   
      PetscBarrier(PETSC_NULL);
 
      sprintf(filen, "spph0_%06d_%1d.dat",ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->P_sum0, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "spph0_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
 
      PetscBarrier(PETSC_NULL);

      sprintf(filen, "spph1_%06d_%1d.dat",ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->P_sum1, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "spph1_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
 
      PetscBarrier(PETSC_NULL);

      sprintf(filen, "spph2_%06d_%1d.dat",ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->P_sum2, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "spph2_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
 
      PetscBarrier(PETSC_NULL);

      sprintf(filen, "spph3_%06d_%1d.dat",ti, user->_this);
      PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
      VecView(user->P_sum3, viewer);
      PetscViewerDestroy(&viewer);
      sprintf(filen, "spph3_%06d_%1d.dat.info",ti, user->_this);	if(!rank) unlink(filen);
 
      PetscBarrier(PETSC_NULL);

     }




  }
  
  if(les) {
    Vec Cs;
    
    VecDuplicate(user->P, &Cs);
    DMLocalToGlobalBegin(user->da, user->lCs, INSERT_VALUES, Cs);
    DMLocalToGlobalEnd(user->da, user->lCs, INSERT_VALUES, Cs);
    
    sprintf(filen, "cs_%06d_%1d.dat",  ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(Cs, viewer);
    PetscViewerDestroy(&viewer);
    
    PetscBarrier(PETSC_NULL);
    VecDestroy(&Cs);
  }
  
  if(rans) {
    sprintf(filen, "kfield%06d_%1d.dat", ti, user->_this);
    PetscViewerBinaryOpen(PETSC_COMM_WORLD, filen, FILE_MODE_WRITE, &viewer);
    VecView(user->K_Omega, viewer);
    PetscViewerDestroy(&viewer);
    
    PetscBarrier(PETSC_NULL);
  }
  
  return 0;
}

PetscErrorCode Divergence(UserCtx *user )
{
  DM		da = user->da, fda = user->fda;
  DMDALocalInfo	info = user->info;

  PetscInt	xs = info.xs, xe = info.xs + info.xm;
  PetscInt  	ys = info.ys, ye = info.ys + info.ym;
  PetscInt	zs = info.zs, ze = info.zs + info.zm;
  PetscInt	mx = info.mx, my = info.my, mz = info.mz;

  PetscInt	lxs, lys, lzs, lxe, lye, lze;
  PetscInt	i, j, k;

  Vec		Div;
  PetscReal	***div, ***aj, ***nvert,***p;
  Cmpnts	***ucont;
  PetscReal	maxdiv;

  lxs = xs; lxe = xe;
  lys = ys; lye = ye;
  lzs = zs; lze = ze;

  if (xs==0) lxs = xs+1;
  if (ys==0) lys = ys+1;
  if (zs==0) lzs = zs+1;

  if (xe==mx) lxe = xe-1;
  if (ye==my) lye = ye-1;
  if (ze==mz) lze = ze-1;

  DMDAVecGetArray(fda,user->lUcont, &ucont);
  DMDAVecGetArray(da, user->lAj, &aj);
  VecDuplicate(user->P, &Div);
  DMDAVecGetArray(da, Div, &div);
  DMDAVecGetArray(da, user->lNvert, &nvert);

  for (k=lzs; k<lze; k++) {
    for (j=lys; j<lye; j++) {
      for (i=lxs; i<lxe; i++) {
	maxdiv = fabs((ucont[k][j][i].x - ucont[k][j][i-1].x +
		       ucont[k][j][i].y - ucont[k][j-1][i].y +
		       ucont[k][j][i].z - ucont[k-1][j][i].z)*aj[k][j][i]);
	if (nvert[k][j][i] + nvert[k+1][j][i] + nvert[k-1][j][i] +
	    nvert[k][j+1][i] + nvert[k][j-1][i] +
	    nvert[k][j][i+1] + nvert[k][j][i-1] > 0.1) maxdiv = 0.;
	div[k][j][i] = maxdiv;

      }
    }
  }

  if (zs==0) {
    k=0;
    for (j=ys; j<ye; j++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (ze == mz) {
    k=mz-1;
    for (j=ys; j<ye; j++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (xs==0) {
    i=0;
    for (k=zs; k<ze; k++) {
      for (j=ys; j<ye; j++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (xe==mx) {
    i=mx-1;
    for (k=zs; k<ze; k++) {
      for (j=ys; j<ye; j++) {
	div[k][j][i] = 0;
      }
    }
  }

  if (ys==0) {
    j=0;
    for (k=zs; k<ze; k++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (ye==my) {
    j=my-1;
    for (k=zs; k<ze; k++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }
  DMDAVecRestoreArray(da, Div, &div);
  VecMax(Div, &i, &maxdiv);
  PetscPrintf(PETSC_COMM_WORLD, "Maxdiv %d %d %e\n", ti, i, maxdiv);
  PetscInt mi;
  for (k=zs; k<ze; k++) {
    for (j=ys; j<ye; j++) {
      for (mi=xs; mi<xe; mi++) {
	if (Gidx(mi,j,k,user) ==i) {
	  PetscPrintf(PETSC_COMM_SELF, "MMa %d %d %d\n", mi,j, k);
	}
      }
    }
  }
 

 DMDAVecRestoreArray(da, user->lNvert, &nvert);
  DMDAVecRestoreArray(fda, user->lUcont, &ucont);
  DMDAVecRestoreArray(da, user->lAj, &aj);
  VecDestroy(&Div);
  return(0);
}


PetscErrorCode force(UserCtx *user, double psum[97], double plsum[97], double pu17sum[97], double pl17sum[97], double pu24sum[97], double pl24sum[97], double puavesum[97], double plavesum[97])
{
  DM		da = user->da, fda = user->fda;
  DMDALocalInfo	info = user->info;

  PetscInt	xs = info.xs, xe = info.xs + info.xm;
  PetscInt  	ys = info.ys, ye = info.ys + info.ym;
  PetscInt	zs = info.zs, ze = info.zs + info.zm;
  PetscInt	mx = info.mx, my = info.my, mz = info.mz;

  PetscInt	lxs, lys, lzs, lxe, lye, lze;
  PetscInt	i, j, k;

  PetscReal	 ***nvert,***p;
 
  lxs = xs; lxe = xe;
  lys = ys; lye = ye;
  lzs = zs; lze = ze;

  if (xs==0) lxs = xs+1;
  if (ys==0) lys = ys+1;
  if (zs==0) lzs = zs+1;

  if (xe==mx) lxe = xe-1;
  if (ye==my) lye = ye-1;
  if (ze==mz) lze = ze-1;
  int rank;
  
  MPI_Comm_rank(PETSC_COMM_WORLD, &rank);
 

        DMDAVecGetArray(da, user->lNvert, &nvert);
        DMDAVecGetArray(da, user->P, &p);
	 double plSum[97]; double pSum[97]; double pu[97]; double pl[97]; double plave[97]; double puave[97]; double plaveSum[97]; double puaveSum[97];
	 double pl17[97]; double pu17[97]; double pu17Sum[97]; double pl17Sum[97];  
	 double pl24[97]; double pu24[97]; double pu24Sum[97]; double pl24Sum[97];  
	 for (i=0;i<97;i++) 
		{
 			       plSum[i]=0.0; pSum[i] = 0.0; pl[i]=0.; pu[i]=0.;puave[i]=0.; plave[i]=0.; puaveSum[i]=0.; plaveSum[i]=0.;
				pu24[i]=0.; pl24[i]=0.; pu24Sum[i]=0.; pl24Sum[i]=0.;
				pu17[i]=0.; pl17[i]=0.; pu17Sum[i]=0.; pl17Sum[i]=0.;
		}

	 
	int ks=71,ke=168,count;
	for (k=zs;k<ze;k++){
	 count=0;
	 for (j=ys;j<ye;j++){
	  for (i=xs;i<xe;i++){
	 
	   if ( k>ks && k<ke ){
		if (i==41 && nvert[k][j][i]==1.0  && nvert[k][j+1][i]<1.0 )
		  pu[k-ks-1]+=p[k][j+1][i];

	
		if (i==41 && nvert[k][j][i]==1. && nvert[k][j-1][i]<1.0 )
		  pl[k-ks-1]+=p[k][j-1][i];
         	
		if (nvert[k][j][i]==1.0 && nvert[k][j-1][i]>2.0 && nvert[k][j+1][i]<2.0 )
	 	   puave[k-ks-1]+=p[k][j][i];

		if ( nvert[k][j][i]==1. && nvert[k][j-1][i]<2.0 && nvert[k][j+1][i]>2.0)
		  { plave[k-ks-1]+=p[k][j][i];  }


		if (i==24 && nvert[k][j][i]==1.0 && nvert[k][j-1][i]>2.0 && nvert[k][j+1][i]<2.0 )
		  pu24[k-ks-1]+=p[k][j][i];

		if (i==24 && nvert[k][j][i]==1. && nvert[k][j-1][i]<2.0 && nvert[k][j+1][i]>2.0)
		  pl24[k-ks-1]+=p[k][j][i];


		if (i==17 && nvert[k][j][i]==1.0 && nvert[k][j-1][i]>2.0 && nvert[k][j+1][i]<2.0 )
		  pu17[k-ks-1]+=p[k][j][i];

		if (i==17 && nvert[k][j][i]==1. && nvert[k][j-1][i]<2.0 && nvert[k][j+1][i]>2.0)
		  pl17[k-ks-1]+=p[k][j][i];

            }
	    
	   }   
	  }
		
	 }
	
	  MPI_Allreduce(&pu, &pSum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	  MPI_Allreduce(&pl, &plSum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);

	  MPI_Allreduce(&pu24, &pu24Sum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	  MPI_Allreduce(&pl24, &pl24Sum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	 
	  MPI_Allreduce(&pu17, &pu17Sum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	  MPI_Allreduce(&pl17, &pl17Sum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	 
	  MPI_Allreduce(&puave, &puaveSum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	  MPI_Allreduce(&plave, &plaveSum,97,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);
	 


 
	    PetscPrintf(PETSC_COMM_WORLD, " instantanous forcces\n");
	  

	for (i=0;i<97;i++) 
	{
	   psum[i]+=pSum[i];
	   plsum[i]+=plSum[i];
	   pu24sum[i]+=pu24Sum[i];
	   pl24sum[i]+=pl24Sum[i];

	   pu17sum[i]+=pu17Sum[i];
	   pl17sum[i]+=pl17Sum[i];

	   puavesum[i]+=puaveSum[i]/54;
	   plavesum[i]+=plaveSum[i]/54;

	   PetscPrintf(PETSC_COMM_WORLD, " %d  %6f  %6f \n",i,pSum[i],plSum[i]-pSum[i]);
	}

 
  DMDAVecRestoreArray(da, user->P, &p);
  DMDAVecGetArray(da, user->lNvert, &nvert);

}






PetscErrorCode GridDivergence(UserCtx *user)
{
  DM		da = user->da, fda = user->fda;
  DMDALocalInfo	info = user->info;

  PetscInt	xs = info.xs, xe = info.xs + info.xm;
  PetscInt  	ys = info.ys, ye = info.ys + info.ym;
  PetscInt	zs = info.zs, ze = info.zs + info.zm;
  PetscInt	mx = info.mx, my = info.my, mz = info.mz;

  PetscInt	lxs, lys, lzs, lxe, lye, lze;
  PetscInt	i, j, k;

  Vec		Div;
  PetscReal	***div, ***aj, ***nvert;
  Cmpnts	***ucont;
  PetscReal	maxdiv;

  lxs = xs; lxe = xe;
  lys = ys; lye = ye;
  lzs = zs; lze = ze;

  if (xs==0) lxs = xs+1;
  if (ys==0) lys = ys+1;
  if (zs==0) lzs = zs+1;

  if (xe==mx) lxe = xe-1;
  if (ye==my) lye = ye-1;
  if (ze==mz) lze = ze-1;

  PetscReal    norm;
  VecNorm(user->Vcont, NORM_INFINITY, &norm);
  PetscPrintf(PETSC_COMM_WORLD, "Grid Flux norm  %le\n", norm);

  DMDAVecGetArray(fda,user->lVcont, &ucont);
  DMDAVecGetArray(da, user->lAj, &aj);
  VecDuplicate(user->P, &Div);
  DMDAVecGetArray(da, Div, &div);
  DMDAVecGetArray(da, user->lNvert, &nvert);
  for (k=lzs; k<lze; k++) {
    for (j=lys; j<lye; j++) {
      for (i=lxs; i<lxe; i++) {
	maxdiv = fabs((ucont[k][j][i].x - ucont[k][j][i-1].x +
		       ucont[k][j][i].y - ucont[k][j-1][i].y +
		       ucont[k][j][i].z - ucont[k-1][j][i].z)*aj[k][j][i]);
	if (nvert[k][j][i] + nvert[k+1][j][i] + nvert[k-1][j][i] +
	    nvert[k][j+1][i] + nvert[k][j-1][i] +
	    nvert[k][j][i+1] + nvert[k][j][i-1] > 0.1) maxdiv = 0.;
	div[k][j][i] = maxdiv;
      }
    }
  }

  if (zs==0) {
    k=0;
    for (j=ys; j<ye; j++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (ze == mz) {
    k=mz-1;
    for (j=ys; j<ye; j++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (xs==0) {
    i=0;
    for (k=zs; k<ze; k++) {
      for (j=ys; j<ye; j++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (xe==mx) {
    i=mx-1;
    for (k=zs; k<ze; k++) {
      for (j=ys; j<ye; j++) {
	div[k][j][i] = 0;
      }
    }
  }

  if (ys==0) {
    j=0;
    for (k=zs; k<ze; k++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }

  if (ye==my) {
    j=my-1;
    for (k=zs; k<ze; k++) {
      for (i=xs; i<xe; i++) {
	div[k][j][i] = 0.;
      }
    }
  }
  DMDAVecRestoreArray(da, Div, &div);
  VecMax(Div, &i, &maxdiv);
  PetscPrintf(PETSC_COMM_WORLD, "Maxdiv Grid %d %d %e\n", ti, i, maxdiv);
  PetscInt mi;
  for (k=zs; k<ze; k++) {
    for (j=ys; j<ye; j++) {
      for (mi=xs; mi<xe; mi++) {
	if (Gidx(mi,j,k,user) ==i) {
	  PetscPrintf(PETSC_COMM_SELF, "Maxdiv Grid location %d %d %d\n", mi,j, k);
	}
      }
    }
  }
    
  DMDAVecRestoreArray(da, user->lNvert, &nvert);
  DMDAVecRestoreArray(fda, user->lVcont, &ucont);
  DMDAVecRestoreArray(da, user->lAj, &aj);
  VecDestroy(&Div);
  return(0);
}

//-----------------------------------------------------------------------------------------------
#undef __FUNCT__
#define __FUNCT__ "main"

int main(int argc, char **argv) {

  UserCtx    *user;
  PetscInt   i, bi, ibi;  
  IBMNodes   *ibm;
  IBMVNodes  *ibmv;
  FSInfo     *fsi;
  PetscBool  DoSCLoop;
  PetscInt   itr_sc;
  Cstart     cstart;
  PetscInt   level;
  UserMG     usermg;
  PetscBool  flg;
  FE         *fem;

  PetscInitialize(&argc, &argv, (char *)0, help);

  PetscOptionsInsertFile(PETSC_COMM_WORLD, "control.dat", PETSC_TRUE);
  PetscOptionsGetInt(PETSC_NULL, "-tio", &tiout, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-phave", &phave, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-imm", &immersed, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-inv", &invicid, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-rstart", &tistart, &rstart_flg);
  PetscOptionsGetInt(PETSC_NULL, "-rstart_fem", &rstart_fem, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-imp", &implicit, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-imp_type", &implicit_type, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-imp_MAX_IT", &imp_MAX_IT, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-fsi", &movefsi, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-rfsi", &rotatefsi, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-radi", &radi, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-inlet", &inletprofile, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-str", &STRONG_COUPLING, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-rs_fsi", &rstart_fsi, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-cop", &cop, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-fish", &fish, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-pizza", &pizza, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-rheology", &rheology, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-duplicate", &duplicate, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-Pipe", &Pipe, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-turbine", &turbine, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-fishcyl", &fishcyl, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-eel", &eel, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-cstart", &fish_c, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-wing", &wing, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-sediment", &sediment, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-mhv", &MHV, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-bhv", &BHV, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-beam", &beam, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-inv_flg", &inv_flg, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-hydro", &hydro, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-lv", &LV, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-reg", &regime, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-twoD", &TwoD, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-thin", &thin, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-dgf_z", &dgf_z, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-dgf_y", &dgf_y, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-dgf_x", &dgf_x, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-dgf_az", &dgf_az, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-dgf_ay", &dgf_ay, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-dgf_ax", &dgf_ax, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-body", &NumberOfBodies, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-nbody", &nbody, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-mframe", &moveframe, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-rframe", &rotateframe, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-blk", &blank, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-init1", &InitialGuessOne, PETSC_NULL);

  PetscOptionsGetReal(PETSC_NULL, "-x_c", &(CMx_c), PETSC_NULL);
  PetscOptionsGetReal(PETSC_NULL, "-y_c", &(CMy_c), PETSC_NULL);
  PetscOptionsGetReal(PETSC_NULL, "-z_c", &(CMz_c), PETSC_NULL);

  PetscOptionsGetReal(PETSC_NULL, "-imp_atol", &(imp_atol), PETSC_NULL);
  PetscOptionsGetReal(PETSC_NULL, "-imp_rtol", &(imp_rtol), PETSC_NULL);
  PetscOptionsGetReal(PETSC_NULL, "-imp_stol", &(imp_stol), PETSC_NULL);
  PetscOptionsGetReal(PETSC_NULL, "-poisson_tol", &poisson_tol, PETSC_NULL);		// Seokkoo Kang: tolerance of implicit matrix free solver. 1.e-4 is enough for most cases.

  PetscOptionsGetInt(PETSC_NULL, "-les", &les, PETSC_NULL);				// Seokkoo Kang: if 1 Smagorinsky with Cs=0.1, if 2 Dynamic model
  PetscOptionsGetInt(PETSC_NULL, "-rans", &rans, PETSC_NULL);			// Seokkoo Kang
  PetscOptionsGetInt(PETSC_NULL, "-wallfunction", &wallfunction, PETSC_NULL);	// Seokkoo Kang: 1 or 2
  PetscOptionsGetInt(PETSC_NULL, "-mixed", &mixed, PETSC_NULL);			// Seokkoo Kang: mixed model option for LES
  PetscOptionsGetInt(PETSC_NULL, "-clark", &clark, PETSC_NULL);			// Seokkoo Kang: mixed model option for LES
  PetscOptionsGetInt(PETSC_NULL, "-dynamic_freq", &dynamic_freq, PETSC_NULL);		// Seokkoo Kang: LES dynamic compute frequency 
  PetscOptionsGetInt(PETSC_NULL, "-averaging", &averaging, PETSC_NULL);	// Seokkoo Kang: if 1 do averaging; always begin with -rstart 0

  PetscOptionsGetInt(PETSC_NULL, "-grid1d", &grid1d, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-i_periodic", &i_periodic, PETSC_NULL);	
  PetscOptionsGetInt(PETSC_NULL, "-j_periodic", &j_periodic, PETSC_NULL);	
  PetscOptionsGetInt(PETSC_NULL, "-k_periodic", &k_periodic, PETSC_NULL);	
  PetscOptionsGetInt(PETSC_NULL, "-period", &period, PETSC_NULL);

  PetscOptionsGetInt(PETSC_NULL, "-pbc_domain", &blkpbc, PETSC_NULL);

  PetscOptionsGetInt(PETSC_NULL, "-testfilter_ik", &testfilter_ik, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-testfilter_1d", &testfilter_1d, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-poisson", &poisson, PETSC_NULL);
  /*PetscOptionsGetInt(PETSC_NULL, "-i_homo_filter", &i_homo_filter, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-j_homo_filter", &j_homo_filter, PETSC_NULL);
  PetscOptionsGetInt(PETSC_NULL, "-k_homo_filter", &k_homo_filter, PETSC_NULL);
  */
  PetscOptionsGetReal(PETSC_NULL, "-max_cs", &max_cs, PETSC_NULL);
  
  PetscOptionsGetReal(PETSC_NULL, "-St_exp", &(St_exp), PETSC_NULL);
  PetscOptionsGetReal(PETSC_NULL, "-wlngth", &(wavelength), PETSC_NULL);
    
  PetscPrintf(PETSC_COMM_WORLD, "tiout %d %le %le thin %d!\n",tiout, imp_atol,imp_rtol,thin);

  if (MHV>0 && MHV<3) 
    L_dim=1./25.82;
  else
    L_dim=1.;
  
  if (LV) {
    L_dim=1.;
    CMz_c=0.;CMy_c=0.;CMx_c=0.;
  } 
  
  if (MHV==1) NumberOfBodies=4;
  if (MHV==2) NumberOfBodies=4;
  if (MHV==3) NumberOfBodies=4;
  
  if (BHV || inv_flg) {
    PetscMalloc(nbody*sizeof(FE), &fem);
    if (BHV) L_dim = 1./25.82;
  }

  if (immersed) {
    ibm=(IBMNodes *)calloc(NumberOfBodies,sizeof(IBMNodes));
    ibmv=(IBMVNodes *)calloc(NumberOfBodies,sizeof(IBMVNodes));
    fsi=(FSInfo *)calloc(NumberOfBodies,sizeof(FSInfo));
    for (ibi=0;ibi<NumberOfBodies;ibi++) 
      FsiInitialize(0, &fsi[ibi], ibi);
  }

  MG_Initial(&usermg, ibm);

  if (immersed) {
    level = usermg.mglevels-1;
    user = usermg.mgctx[level].user;
    for (bi=0; bi<block_number; bi++) {
      user[bi].ibmlist=(IBMList *)malloc(NumberOfBodies*sizeof(IBMList));
      for (ibi=0;ibi<NumberOfBodies;ibi++) {
	InitIBMList(&(user[bi].ibmlist[ibi]));
      }
    }
      
    if (MHV==1){
      bi=0;
      L_dim=1./25.82;
      PetscBool flag= PETSC_FALSE;
      //
      ibi=0;
      ibm_read_Icem(&ibm[ibi],ibi);
      ibm_surface_VTKOut(&ibm[ibi],ibi,0);
      PetscPrintf(PETSC_COMM_WORLD, "Ibm read housing %d !\n", ibi);
      ////
      for (ibi=1; ibi<NumberOfBodies; ibi++) {		
	ibm_read_Icem(&ibm[ibi],ibi);
	PetscPrintf(PETSC_COMM_WORLD, "Ibm read leaflet %d !\n", ibi);
	ibm_surface_out(&ibm[ibi], 0, ibi);
	FsiInitialize(0, &fsi[ibi], ibi);
      }
      //
      for (ibi=1; ibi<NumberOfBodies; ibi++) {
	if (ibi == 1) {
	  fsi[ibi].x_c = 0.21776; fsi[ibi].y_c = -0.314928; fsi[ibi].z_c=0.194184;
	} else if (ibi == 2) {
	  fsi[ibi].x_c = 0.374746; fsi[ibi].y_c = -0.015315; fsi[ibi].z_c=0.194184;
	} else if (ibi == 3) {
	  fsi[ibi].x_c = -0.381594; fsi[ibi].y_c = -0.018947; fsi[ibi].z_c=0.194184;
	}
	////
	fsi[ibi].S_ang_n[0]=-2.*PI/180.;
	Elmt_Move_FSI_ROT(&fsi[ibi], &ibm[ibi], user[bi].dt, ibi);
	//
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp0[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp0[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp0[i] = ibm[ibi].z_bp[i];
	  //
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	}
	
	ibm_surface_VTKOut(&ibm[ibi],ibi,0);
	//
        
      }
      fluxin_novostia(&(usermg.mgctx[usermg.mglevels-1].user[0]));
    } else if (wing) {
      for (i=0;i<NumberOfBodies;i++) {
	if (i==0) {
	  if (NumberOfBodies==1) {
	    ibm_read_Ansys(&ibm[i],i);
	    
	    PetscPrintf(PETSC_COMM_WORLD, "Ibm read fish!\n");
	    PetscReal scale[7];
	    ibm_scale(&ibm[i],scale);
	    calc_ibm_normal(&ibm[i]);
	    
	    PetscBarrier(PETSC_NULL);
	    FsiInitialize(0, &fsi[i], i);
	    fsi[i].x_c=0.;
	    fsi[i].y_c=0.;
	    fsi[i].z_c=0.;
	    if (rotateframe) {
	    }else 	      
	      fsi[i].S_ang_n[4]=1.18;
	    PetscPrintf(PETSC_COMM_WORLD, "wing init done!! dt %le \n", user[0].dt);
	  }
	}
      }
    } else
      
      if (fish) {
	Flux_in=1.;
	for (i=0;i<NumberOfBodies;i++) {
	  if (NumberOfBodies>3) {
	    if (i==1) {
	      CMz_c=3.0;//2.;
	      CMx_c=2.1;
	    }
	    if (i==2) {
	      CMz_c=3.0;//2.;
	      CMx_c=-0.1;
	    }
	    if (i==3) {
	      CMz_c=4.5;//2.;
	      CMx_c=1.0;
	    }
	  }
	  
	  if (!fishcyl || i<1){
	    ibm_read_Icem(&ibm[i],i);
	    
	    PetscPrintf(PETSC_COMM_WORLD, "Ibm read fish!\n");
	    PetscBarrier(PETSC_NULL);
	    if (St_exp>0.01) {	    
	      for (bi=0;bi<block_number;bi++) 
		fish_init(&(user[bi].dt));
	    }
	  }
	  
	  // read cyl
	  if (i==1 && fishcyl) {
	    
	    CMz_c=1.9;//2.;
	    CMy_c=-.05;
	    CMx_c=2.;
	    
	    ibm_read_ucd(&ibm[i], i);
	    PetscPrintf(PETSC_COMM_WORLD, "Ibm read Cyl!\n");
	    
	    PetscBarrier(PETSC_NULL);
	    // init for fsi
	    FsiInitialize(0, &fsi[i], i);
	  }
	  
	  FsiInitialize(0, &fsi[i], i);
	  Initialize_Projecting(&ibm[i]);
	  PetscPrintf(PETSC_COMM_WORLD, " fish init done!! dt %le \n", user[0].dt);
	} // for i 
	
	ti = 0;
	//      ibi=0;
	bi=0;
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  if (St_exp>0.01 && (!fishcyl || ibi<1)) {
	    fish_swim(&ibm[ibi], (ti-3)*user[bi].dt, user[bi].dt);
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	    }
	    fish_swim(&ibm[ibi], (ti-2)*user[bi].dt, user[bi].dt);
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	      
	      ibm[ibi].urm1[i].x = ibm[ibi].u[i].x;
	      ibm[ibi].urm1[i].y = ibm[ibi].u[i].y;
	      ibm[ibi].urm1[i].z = ibm[ibi].u[i].z;
	    }
	    
	    fish_swim(&ibm[ibi], (ti-1)*user[bi].dt, user[bi].dt);
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	      
	      ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	      ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	      ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	    }
	    fish_swim(&ibm[ibi], (ti)*user[bi].dt, user[bi].dt);
	  } // if St_exp
	} // for ibi
      } else if (cop) {
	for (i=0;i<NumberOfBodies;i++) {
	  ibm_read_Ansys(&ibm[i],i);
	  PetscPrintf(PETSC_COMM_WORLD, "Ibm read cop!\n");
	  PetscBarrier(PETSC_NULL);
	  FsiInitialize(0, &fsi[i], i);
	  PetscPrintf(PETSC_COMM_WORLD, " cop init done!! dt %le \n", user[0].dt);
	}
	cop_init(ibm);
	cop_init_time(regime, &(user[0].dt));
	
	cop_swim(ibm, 0.*user[0].dt, user[0].dt);
	
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	    ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	    ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  }
	}
      } else if (fish_c) {
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  // read the sunfish
	  PetscPrintf(PETSC_COMM_WORLD, "Cstart init!! \n");
	  
	  ibm_read_Ansys(&ibm[ibi],ibi);
	  PetscReal scale[7];
	  ibm_scale(&ibm[ibi],scale); //scale the sunfish
	  
	  cstart.zmin=scale[0];cstart.zmax=1.;//scale[1];
	  cstart.ymin=scale[2];cstart.ymax=scale[3];
	  cstart.xmin=scale[4];cstart.xmax=scale[5];
	  PetscPrintf(PETSC_COMM_WORLD, "zmin/max %le %le y %le %le x %le %le\n",cstart.zmin,cstart.zmax,cstart.ymin,cstart.ymax,cstart.xmin,cstart.xmax);
	  
	  read_midpoint(&cstart); //read midpoints and the motion during C-start
	  PetscPrintf(PETSC_COMM_SELF, "READ midpoints done! %d %d %d %le %le\n",cstart.n_time,cstart.n_midp, cstart.n_subit,cstart.x_midp[1],cstart.y_midp[1]);
	  
	  FsiInitialize(0, &fsi[ibi], ibi);
	  PetscPrintf(PETSC_COMM_WORLD, "Cstart FSI init!! dt %le \n", user[0].dt);
	  
	  ti=0;
	  form_cstart(&cstart, &ibm[ibi], &fsi[ibi], user[0].dt, ibi,rotateframe);
	  
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	    ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	    ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  }
	  for (i=0;i<6;i++){
	    fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	    fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	    
	    fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	    fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	  }
	  
	}
      }  else if (pizza){
	for (i=0;i<NumberOfBodies;i++) {
	  ibm_read_Ansys(&ibm[i],i);
	  PetscPrintf(PETSC_COMM_WORLD, "Ibm read pizza box!\n");
	  
	  if (St_exp>0.01) {
	    for (bi=0;bi<block_number;bi++)
	      fish_init(&(user[bi].dt));
	  }
	  FsiInitialize(0, &fsi[i], i);
	  Initialize_Projecting(&ibm[i]);
	  PetscPrintf(PETSC_COMM_WORLD, "pizza box init done!! dt %le \n", user[0].dt);
	}
	ti = 0;
	bi=0;
	
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  if (St_exp>0.01 && (!fishcyl || ibi<1)) {
	    pizza_box_swim(&ibm[ibi], (ti-3)*user[bi].dt, user[bi].dt);
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	    }
	    pizza_box_swim(&ibm[ibi], (ti-2)*user[bi].dt, user[bi].dt);
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	      
	      ibm[ibi].urm1[i].x = ibm[ibi].u[i].x;
	      ibm[ibi].urm1[i].y = ibm[ibi].u[i].y;
	      ibm[ibi].urm1[i].z = ibm[ibi].u[i].z;
	    }
	    
	    pizza_box_swim(&ibm[ibi], (ti-1)*user[bi].dt, user[bi].dt);
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	      
	      ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	      ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	      ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	    }
	    pizza_box_swim(&ibm[ibi], (ti)*user[bi].dt, user[bi].dt);
	    
	  }
	}
        
      }
      else if(Pipe){
	i=0;
	PetscPrintf(PETSC_COMM_WORLD, "Pipe test for drag \n");  
	ibm_read_Ansys(&ibm[i], i);
	ibm_surface_VTKOut(&ibm[i],i,0);
	
      }
      else if (BHV || inv_flg) {
	
	for (ibi=0; ibi<NumberOfBodies; ibi++) {
	  L_dim = 1.0; 	  
	  ibm_read_Icem(&ibm[ibi], ibi); 	    
	  
	  if (BHV) {
	    PetscReal  angle=0.;
	    if (ibi<6)  angle = 3.14159/2.;
	    RotateBHVleaflet(&ibm[ibi], angle); 
	  }

	  calc_ibm_normal(&ibm[ibi]); 
	  ibm_surface_VTKOut(&ibm[ibi], ibi, 0);
	  
	  Initialize_Projecting(&ibm[ibi]);	    
	}//ibi
	
	fem_Initial(ibm, fem, user[0].dt);
      }
      
      else if (rheology) {
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  FsiInitialize(0, &fsi[ibi], ibi);
	}
	if (duplicate) {
	  i=0;
	  ibm_read_Ansys(&ibm[i], i);
	  ibm_read_Ansys_vol(&ibmv[i], i);
	  ibmv_cent_of_mass( &ibmv[i],&fsi[i], i);
	  
	  ibm_volume_VTKOut(&ibmv[i],i,0);
	  
	  for (i=0;i<NumberOfBodies;i++) {
	    ibm_surface_VTKOut(&ibm[i],i,0);
	  }
	}else{
	  
	  for (i=0;i<NumberOfBodies;i++) {
	    if (i==0) {
	      CMx_c=1.2;
	      CMy_c=2.0;
	      CMz_c=1.2;
	    }
	    else if (i==1){
	      CMx_c=1.2;
	      CMy_c=1.2;
	      CMz_c=1.35;
	    }else{
	      CMx_c=1.0;
	      CMy_c=1.9;
	      CMz_c=1.2;
	    }
	    ibm_read_Ansys(&ibm[i], i);
	    ibm_surface_VTKOut(&ibm[i],i,0);
	    ibm_read_Ansys_vol(&ibmv[i], i); 
	    FsiInitialize(0, &fsi[i], i);
	    ibmv_cent_of_mass( &ibmv[i],&fsi[i], i);
	    ibm_volume_VTKOut(&ibmv[i],i,0);
	  }
	}
      }else {
	for (i=0;i<NumberOfBodies;i++) {
	  
	  PetscPrintf(PETSC_COMM_WORLD, "Ibm read!\n");
	  
	  if (NumberOfBodies>10 && i>0)
	    
	    ibm_read_ucd(&ibm[i], 0);
	  
	  else{
	    
	    ibm_read_Icem(&ibm[i],i);
	    
	    ibm_surface_VTKOut(&ibm[i],i,0);
	  }	// init for fsi
	  
	  FsiInitialize(0, &fsi[i], i);
	  
	  if (NumberOfBodies>10 && i>0) {
	    PetscInt Nibm_y=13, Nibm_z=14;
	    PetscReal dYibm=1.5, dZibm=-1.5;
	    ibm_placement(&ibm[i], &fsi[i], Nibm_y, Nibm_z, dYibm, dZibm, i);
	  } else
	    fsi[i].z_c +=i*2.;
	  PetscBarrier(PETSC_NULL);
	}
      }
  }
  
  if (immersed) {
    ti = 0;
    if (rstart_flg) ti = tistart;
  }
  
  level = usermg.mglevels-1;
  user = usermg.mgctx[level].user;
  if (rstart_flg) {
    ti = tistart; tistart++;
    
    for (bi=0; bi<block_number; bi++) {
      Ucont_P_Binary_Input(&(user[bi]));
      
      DMGlobalToLocalBegin(user[bi].fda, user[bi].Ucont,INSERT_VALUES, user[bi].lUcont);
      DMGlobalToLocalEnd(user[bi].fda, user[bi].Ucont,INSERT_VALUES, user[bi].lUcont);
      
      DMGlobalToLocalBegin(user[bi].da, user[bi].P,INSERT_VALUES, user[bi].lP);
      DMGlobalToLocalEnd(user[bi].da, user[bi].P,INSERT_VALUES, user[bi].lP);
      
      Contra2Cart(&(user[bi]));
      
      /* /////////////////////////////////////////////////////////////rstart */
      if (rstart_fem) {
      	PetscInt  nv;
      	for (ibi=0; ibi<NumberOfBodies; ibi++) {
      	  if (ibi<3) {
	    
      	    BroadcastIBM(&ibm[ibi]);
      	    BroadcastIBM_old(&ibm[ibi]);
      	    PetscBarrier(PETSC_NULL);
	    
      	    calc_ibm_normal(&ibm[ibi]); //clac normals and areas
      	    calc_ibm_velocity(&ibm[ibi], user[bi].dt);
	    
      	    for (nv=0; nv<ibm[ibi].n_v; nv++) {
	      
      	      ibm[ibi].uold[nv].x = ibm[ibi].u[nv].x;
      	      ibm[ibi].uold[nv].y = ibm[ibi].u[nv].y;
      	      ibm[ibi].uold[nv].z = ibm[ibi].u[nv].z;
      	    }
	    
      	  }else{
      	    for (nv=0; nv<ibm[ibi].n_v; nv++) {
      	      ibm[ibi].x_bp_o[nv] = ibm[ibi].x_bp[nv];
      	      ibm[ibi].y_bp_o[nv] = ibm[ibi].y_bp[nv];
      	      ibm[ibi].z_bp_o[nv] = ibm[ibi].z_bp[nv];
      	    }
      	  }
      	  ibm_surface_VTKOut(&ibm[ibi], ibi, ti);
      	}
	
      	PetscPrintf(PETSC_COMM_WORLD, "done fem restart!\n");
      }
      /* /////////////////////////////////////////////////////////// */
      
      if (rheology){
		
	PetscReal rx,ry,rz;
	Cmpnts    omega_c;
	
	for (ibi=0;ibi<NumberOfBodies;ibi++) {

	  FSI_DATA_Input(&fsi[ibi],ibi,ti);
	  
	  fsi[ibi].q[0]=sqrt((fsi[ibi].R[0][0]+fsi[ibi].R[1][1]+fsi[ibi].R[2][2]+1.0)/4.0);
	  fsi[ibi].q[1]=(fsi[ibi].R[2][1]-fsi[ibi].R[1][2])/(4*fsi[ibi].q[0]);
	  fsi[ibi].q[2]=(fsi[ibi].R[1][0]+fsi[ibi].R[0][1])/(4*fsi[ibi].q[1]);
	  fsi[ibi].q[3]=(fsi[ibi].R[0][2]+fsi[ibi].R[2][0])/(4*fsi[ibi].q[1]);
	  
	  fsi[ibi].a_c[0]=fsi[ibi].x_c-fsi[ibi].S_new[0];
	  fsi[ibi].a_c[1]=fsi[ibi].y_c-fsi[ibi].S_new[2];
	  fsi[ibi].a_c[2]=fsi[ibi].z_c-fsi[ibi].S_new[4];
	  
	  PetscPrintf(PETSC_COMM_WORLD, " initial center of mass: a_c.x %le a_c.y %le a_c.z %le \n", fsi[ibi].a_c[0], fsi[ibi].a_c[1], fsi[ibi].a_c[2]);	 	  
	  PetscPrintf(PETSC_COMM_WORLD, "R[0][0] %le R[0][1] %le R[0][2] %le R[1][0] %le R[1][1] %le  R[1][2] %le  R[2][0] %le R[2][1] %le R[2][2] %le\n",fsi[ibi].R[0][0],fsi[ibi].R[0][1],fsi[ibi].R[0][2],fsi[ibi].R[1][0],fsi[ibi].R[1][1],fsi[ibi].R[1][2],fsi[ibi].R[2][0],fsi[ibi].R[2][1],fsi[ibi].R[2][2]);
	  PetscPrintf(PETSC_COMM_WORLD, "q[0] %le q[1] %le q[2] %le q[3] %le \n",	fsi[ibi].q[0],	fsi[ibi].q[1],	fsi[ibi].q[2],	fsi[ibi].q[3]);
	  PetscPrintf(PETSC_COMM_WORLD, "L_x %le L_y %le L_z %le  \n",fsi[ibi].L_n[0],fsi[ibi].L_n[1],fsi[ibi].L_n[2]);
	  PetscPrintf(PETSC_COMM_WORLD, "w_x %le w_y %le w_z %le  \n",fsi[ibi].S_ang_n[1],fsi[ibi].S_ang_n[3],fsi[ibi].S_ang_n[5]);
	  PetscPrintf(PETSC_COMM_WORLD, "M_x %le M_y %le M_z %le  \n",fsi[ibi].M_x,fsi[ibi].M_y,fsi[ibi].M_z);
	  
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    
	    rx = ibm[ibi].x_bp0[i]- fsi[ibi].a_c[0];
	    ry = ibm[ibi].y_bp0[i]- fsi[ibi].a_c[1];
	    rz = ibm[ibi].z_bp0[i]- fsi[ibi].a_c[2];
	    
	    ibm[ibi].x_bp[i] =fsi[ibi].R[0][0]*rx+fsi[ibi].R[0][1]*ry+fsi[ibi].R[0][2]*rz+fsi[ibi].x_c;
	    ibm[ibi].y_bp[i] =fsi[ibi].R[1][0]*rx+fsi[ibi].R[1][1]*ry+fsi[ibi].R[1][2]*rz+fsi[ibi].y_c;
	    ibm[ibi].z_bp[i] =fsi[ibi].R[2][0]*rx+fsi[ibi].R[2][1]*ry+fsi[ibi].R[2][2]*rz+fsi[ibi].z_c;
	  }
	  
	  ibm_surface_VTKOut(&ibm[ibi],ibi,ti);
	  calc_ibm_normal(&ibm[ibi]);
	  
	  for (i=0;i<6;i++){
	    fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	  }
	  
	  fsi[ibi].M_x_real=fsi[ibi].M_x;
	  fsi[ibi].M_y_real=fsi[ibi].M_y;
	  fsi[ibi].M_z_real=fsi[ibi].M_z;
	  
	  for (i=0;i<3;i++){
	    fsi[ibi].L_r[i]=fsi[ibi].L_n[i];
	  }
	  
	  for (i=0;i<4;i++){
	    fsi[ibi].q_r[i]=fsi[ibi].q[i];
	  }
	  omega_c.x=fsi[ibi].S_ang_n[1];
	  omega_c.y=fsi[ibi].S_ang_n[3];
	  omega_c.z=fsi[ibi].S_ang_n[5];
	  // axis of frame rotation
	  
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    rx = ibm[ibi].x_bp[i]-fsi[ibi].x_c;
	    ry = ibm[ibi].y_bp[i]-fsi[ibi].y_c;
	    rz = ibm[ibi].z_bp[i]-fsi[ibi].z_c;
	    ibm[ibi].u[i].x =   (rz*omega_c.y-omega_c.z*ry)+fsi[ibi].S_new[1]  ;
	    ibm[ibi].u[i].y =   (rx*omega_c.z-omega_c.x*rz)+fsi[ibi].S_new[3]  ;
	    ibm[ibi].u[i].z =   (ry*omega_c.x-omega_c.y*rx)+fsi[ibi].S_new[5]  ;
	    
	  }
	  ibm_search_advanced(&(user[bi]), &ibm[ibi], ibi);
	}
      }
      if (fish) {
	ibi=0;
	fish_swim(&ibm[ibi],(ti-2)*user[bi].dt, user[bi].dt);
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	}
	fish_swim(&ibm[ibi], (ti-1)*user[bi].dt, user[bi].dt);
	if (moveframe) {
	  FSI_DATA_Input(&fsi[ibi],ibi,ti-1);
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].u[i].x += fsi[ibi].S_new[1];
	    ibm[ibi].u[i].y += fsi[ibi].S_new[3];
	    ibm[ibi].u[i].z += fsi[ibi].S_new[5];
	  }
	}
	
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  
	  ibm[ibi].urm1[i].x = ibm[ibi].u[i].x;
	  ibm[ibi].urm1[i].y = ibm[ibi].u[i].y;
	  ibm[ibi].urm1[i].z = ibm[ibi].u[i].z;
	}
	
	fish_swim(&ibm[ibi], (ti)*user[bi].dt, user[bi].dt);
	if (moveframe) {
	  FSI_DATA_Input(&fsi[ibi],ibi,ti);
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].u[i].x += fsi[ibi].S_new[1];
	    ibm[ibi].u[i].y += fsi[ibi].S_new[3];
	    ibm[ibi].u[i].z += fsi[ibi].S_new[5];
	  }
	  for (i=0;i<6;i++){
	    fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	    fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	    
	    fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	    fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	  }
	  
	  fsi[ibi].F_x_real=fsi[ibi].F_x;
	  fsi[ibi].F_y_real=fsi[ibi].F_y;
	  fsi[ibi].F_z_real=fsi[ibi].F_z;
	  
	  fsi[ibi].M_x_real=fsi[ibi].M_x;
	  fsi[ibi].M_y_real=fsi[ibi].M_y;
	  fsi[ibi].M_z_real=fsi[ibi].M_z;
	  
	}
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];

	  ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	  ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	  ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	}

      }
      if (pizza) {
	
	ibi=0;
	pizza_box_swim(&ibm[ibi],(ti-2)*user[bi].dt, user[bi].dt);
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	}
	pizza_box_swim(&ibm[ibi], (ti-1)*user[bi].dt, user[bi].dt);
	if (moveframe) {
	  FSI_DATA_Input(&fsi[ibi],ibi,ti-1);
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].u[i].x += fsi[ibi].S_new[1];
	    ibm[ibi].u[i].y += fsi[ibi].S_new[3];
	    ibm[ibi].u[i].z += fsi[ibi].S_new[5];
	  }
	}
	
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  
	  ibm[ibi].urm1[i].x = ibm[ibi].u[i].x;
	  ibm[ibi].urm1[i].y = ibm[ibi].u[i].y;
	  ibm[ibi].urm1[i].z = ibm[ibi].u[i].z;
	}
	
	pizza_box_swim(&ibm[ibi], (ti)*user[bi].dt, user[bi].dt);
	if (moveframe) {
	  FSI_DATA_Input(&fsi[ibi],ibi,ti);
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].u[i].x += fsi[ibi].S_new[1];
	    ibm[ibi].u[i].y += fsi[ibi].S_new[3];
	    ibm[ibi].u[i].z += fsi[ibi].S_new[5];
	  }
	  for (i=0;i<6;i++){
	    fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	    fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	    
	    fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	    fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	  }
	  
	  fsi[ibi].F_x_real=fsi[ibi].F_x;
	  fsi[ibi].F_y_real=fsi[ibi].F_y;
	  fsi[ibi].F_z_real=fsi[ibi].F_z;
	  
	  fsi[ibi].M_x_real=fsi[ibi].M_x;
	  fsi[ibi].M_y_real=fsi[ibi].M_y;
	  fsi[ibi].M_z_real=fsi[ibi].M_z;
	  
	}
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  
	  ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	  ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	  ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	}
	
      }
      if (fish_c) {
	Cmpnts	omega_c, a_c;
	PetscReal rx,ry,rz;
	ibi=0;
	ti=tistart-2;
	form_cstart(&cstart, &ibm[ibi], &fsi[ibi], user[0].dt, ibi,rotateframe);
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	}
	for (i=0;i<6;i++){
	  fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	  fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	  
	  fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	  fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	}
	ti=tistart-1;
	form_cstart(&cstart, &ibm[ibi], &fsi[ibi], user[0].dt, ibi, rotateframe);
	if (rotateframe) {	  
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    // omega_c is frame angular speed
	    omega_c.x=-fsi[ibi].S_ang_n[1];
	    omega_c.y=-fsi[ibi].S_ang_n[3];
	    omega_c.z=-fsi[ibi].S_ang_n[5];
	    
	    // axis of frame rotation
	    a_c.x=0.2;//fsi[ibi].x_c;
	    a_c.y=0.;//fsi[ibi].y_c;
	    a_c.z=-0.6;//fsi[ibi].z_c;
	    
	    ibm[ibi].u[i].x += fsi[ibi].S_new[1];
	    ibm[ibi].u[i].y += fsi[ibi].S_new[3];
	    ibm[ibi].u[i].z += fsi[ibi].S_new[5];
	    
	    rx = ibm[ibi].x_bp[i]-a_c.x;
	    ry = ibm[ibi].y_bp[i]-a_c.y;
	    rz = ibm[ibi].z_bp[i]-a_c.z;
	    ibm[ibi].u[i].x -=   ry*omega_c.z-omega_c.y*rz  ;
	    ibm[ibi].u[i].y += ( rx*omega_c.z-omega_c.x*rz );
	    ibm[ibi].u[i].z -=   rx*omega_c.y-omega_c.x*ry  ;
	  }
	}//if rotate frame	  
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  
	  ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	  ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	  ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	}
	for (i=0;i<6;i++){
	  fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	  fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	  
	  fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	  fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	}
      }
      
      if (cop) {
	
	cop_swim(ibm, (ti-2)*user[bi].dt, user[bi].dt);
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	    ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	    ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  }
	}
	
	cop_swim(ibm, (ti-1)*user[bi].dt, user[bi].dt);
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	    ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	    ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	    
	    ibm[ibi].urm1[i].x = ibm[ibi].u[i].x;
	    ibm[ibi].urm1[i].y = ibm[ibi].u[i].y;
	    ibm[ibi].urm1[i].z = ibm[ibi].u[i].z;
	  }
	}
	
	cop_swim(ibm, (ti)*user[bi].dt, user[bi].dt);
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  for (i=0; i<ibm[ibi].n_v; i++) {
	    ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	    ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	    ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	    
	    ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	    ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	    ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	  }
	}
	
      }
      
      if (rstart_fsi) {
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  
	  FSI_DATA_Input(&fsi[ibi],ibi,ti);
	  
	  if (movefsi) {
	    if (!moveframe)
	      Elmt_Move_FSI_TRANS(&fsi[ibi], &ibm[ibi],ibi);
	    for (i=0;i<6;i++){
	      fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	      fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	    }
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].uold[i].x = fsi[ibi].S_real[1];
	      ibm[ibi].uold[i].y = fsi[ibi].S_real[3];
	      ibm[ibi].uold[i].z = fsi[ibi].S_real[5];
	    }
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].urm1[i].x = fsi[ibi].S_realm1[1];
	      ibm[ibi].urm1[i].y = fsi[ibi].S_realm1[3];
	      ibm[ibi].urm1[i].z = fsi[ibi].S_realm1[5];
	    }
	  }
	  
	  if ((rotatefsi &&  !rotateframe)|| MHV) {
	    
	    ////////////////////////////////////////
	    if(ibi){
	      FSI_DATA_Input(&fsi[ibi],ibi,ti-2);
	      Elmt_Move_FSI_ROT(&fsi[ibi], &ibm[ibi], user[bi].dt, ibi);
	      for (i=0; i<ibm[ibi].n_v; i++) {
		ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
		ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
		ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	      }
	      
	      
	      FSI_DATA_Input(&fsi[ibi],ibi,ti-1);
	      Elmt_Move_FSI_ROT(&fsi[ibi], &ibm[ibi], user[bi].dt, ibi);
	      for (i=0; i<ibm[ibi].n_v; i++) {
		ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
		ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
		ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
		
		ibm[ibi].urm1[i].x = ibm[ibi].u[i].x;
		ibm[ibi].urm1[i].y = ibm[ibi].u[i].y;
		ibm[ibi].urm1[i].z = ibm[ibi].u[i].z;
	      }
	      	      
	      FSI_DATA_Input(&fsi[ibi],ibi,ti);
	      Elmt_Move_FSI_ROT(&fsi[ibi], &ibm[ibi], user[bi].dt, ibi);
	      for (i=0; i<ibm[ibi].n_v; i++) {
		ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
		ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
		ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
		
		ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
		ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
		ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	      }
	    }
	    ////////////////////////////////////////
	    ibm_surface_VTKOut(&ibm[ibi],ibi,0);
	    // if read ti, then will start for ti+1
	    for (i=0;i<6;i++){
	      fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	      fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	    }
	    
	    fsi[ibi].F_x_real=fsi[ibi].F_x;
	    fsi[ibi].F_y_real=fsi[ibi].F_y;
	    fsi[ibi].F_z_real=fsi[ibi].F_z;
	    
	    fsi[ibi].M_x_rm3=fsi[ibi].M_x;
	    fsi[ibi].M_y_rm3=fsi[ibi].M_y;
	    fsi[ibi].M_z_rm3=fsi[ibi].M_z;
	    
	    fsi[ibi].M_x_rm2=fsi[ibi].M_x;
	    fsi[ibi].M_y_rm2=fsi[ibi].M_y;
	    fsi[ibi].M_z_rm2=fsi[ibi].M_z;
	    
	    fsi[ibi].M_x_real=fsi[ibi].M_x;
	    fsi[ibi].M_y_real=fsi[ibi].M_y;
	    fsi[ibi].M_z_real=fsi[ibi].M_z;
	    
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	      ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	      ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	    }
	    
	  }

	  if (rotatefsi &&  rotateframe) {
	   
	    fsi[ibi].S_ang_n[5]=St_exp;
	    fsi[ibi].S_ang_r[5]=St_exp;
	    
	    // if read ti, then will start for ti+1
	    for (i=0;i<6;i++){
	      fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	      fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	    }

	    fsi[ibi].F_x_real=fsi[ibi].F_x;
	    fsi[ibi].F_y_real=fsi[ibi].F_y;
	    fsi[ibi].F_z_real=fsi[ibi].F_z;
	    
	    fsi[ibi].M_x_rm3=fsi[ibi].M_x;
	    fsi[ibi].M_y_rm3=fsi[ibi].M_y;
	    fsi[ibi].M_z_rm3=fsi[ibi].M_z;
	    
	    fsi[ibi].M_x_rm2=fsi[ibi].M_x;
	    fsi[ibi].M_y_rm2=fsi[ibi].M_y;
	    fsi[ibi].M_z_rm2=fsi[ibi].M_z;
	    
	    fsi[ibi].M_x_real=fsi[ibi].M_x;
	    fsi[ibi].M_y_real=fsi[ibi].M_y;
	    fsi[ibi].M_z_real=fsi[ibi].M_z;
	    
	    PetscReal rx,ry,rz;
	    for (i=0; i<ibm[ibi].n_v; i++) {
	      rx = ibm[ibi].x_bp[i]-fsi[ibi].x_c;
	      ry = ibm[ibi].y_bp[i]-fsi[ibi].y_c;
	      rz = ibm[ibi].z_bp[i]-fsi[ibi].z_c;
	      
	      ibm[ibi].u[i].x =-( ry*fsi[ibi].S_ang_n[5]-fsi[ibi].S_ang_n[3]*rz );
	      ibm[ibi].u[i].y = ( rx*fsi[ibi].S_ang_n[5]-fsi[ibi].S_ang_n[1]*rz );
	      ibm[ibi].u[i].z =-( rx*fsi[ibi].S_ang_n[3]-fsi[ibi].S_ang_n[1]*ry );
	      
	      ibm[ibi].uold[i].x =-( ry*fsi[ibi].S_ang_r[5]-fsi[ibi].S_ang_r[3]*rz );
	      ibm[ibi].uold[i].y = ( rx*fsi[ibi].S_ang_r[5]-fsi[ibi].S_ang_r[1]*rz );
	      ibm[ibi].uold[i].z =-( rx*fsi[ibi].S_ang_r[3]-fsi[ibi].S_ang_r[1]*ry );
	      
	      ibm[ibi].urm1[i].x =-( ry*fsi[ibi].S_ang_rm1[5]-fsi[ibi].S_ang_rm1[3]*rz );
	      ibm[ibi].urm1[i].y = ( rx*fsi[ibi].S_ang_rm1[5]-fsi[ibi].S_ang_rm1[1]*rz );
	      ibm[ibi].urm1[i].z =-( rx*fsi[ibi].S_ang_rm1[3]-fsi[ibi].S_ang_rm1[1]*ry );
	      
	    }
	  }
	  
	}//ibi
      } // if rstart fsi
      
    }// bi
    
  } // if rstart

  // do the search once if elmt is not moving!
  if (immersed) {
    for (level = usermg.mglevels-1; level>=usermg.mglevels-1; level--) {
      user = usermg.mgctx[level].user;
      for (bi=0; bi<block_number; bi++) {
	user[bi].ibm=ibm;
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  if (LV && !MHV) {
	    PetscPrintf(PETSC_COMM_WORLD, "IBM_SERA rev %d %d\n", ibi,bi);
	    ibm_search_advanced_rev(&(user[bi]), &ibm[ibi], ibi);
	  } else {
	    if (MHV==2){
	      if ( ibi==NumberOfBodies-1 ){ //  && bi==0
		PetscPrintf(PETSC_COMM_WORLD, "IBM_SERA rev %d %d\n", ibi,bi);
		ibm_search_advanced_rev(&(user[bi]), &ibm[ibi], ibi);
	      } else if (  ibi<NumberOfBodies-1) {//bi>0 &&
		PetscPrintf(PETSC_COMM_WORLD, "IBM_SERA %d %d\n", ibi, bi);
		ibm_search_advanced(&(user[bi]), &ibm[ibi], ibi);
	      }
	    } else if (block_number>1) {
	      if (bi>0) {
		PetscPrintf(PETSC_COMM_WORLD, "IBM_SERA ibi %d bi %d\n", ibi, bi);
		ibm_search_advanced(&(user[bi]), &ibm[ibi], ibi);
	      }
	    }else if (turbine){
	      PetscPrintf(PETSC_COMM_WORLD, "IBM_SERA for Turbine ibi %d bi %d\n", ibi, bi);
	      ibm_search_advanced(&(user[bi]), &ibm[ibi], ibi);
	      calc_ibm_normal(&ibm[ibi]);
	      for (i=0; i<ibm[ibi].n_v; i++) {
		Cmpnts	   omega_c, a_c;
		PetscReal rx,ry,rz;		 
		
		a_c.x=0.0;
		a_c.y=0.0;
		a_c.z=0.0;
		
		omega_c.x=0.0;
		omega_c.y=0.0;
		omega_c.z=-1.07;
		
		rx = ibm[ibi].x_bp[i]-a_c.x;
		ry = ibm[ibi].y_bp[i]-a_c.y;
		rz = ibm[ibi].z_bp[i]-a_c.z;      
		ibm[ibi].u[i].x =   rz*omega_c.y-omega_c.z*ry  ;
		ibm[ibi].u[i].y =   rx*omega_c.z-omega_c.x*rz  ;
		ibm[ibi].u[i].z =   ry*omega_c.x-omega_c.y*rx  ;  
		
	      }
	    } else if (BHV || inv_flg) {
	      if (ibi==6){
		ibm_search_advanced(&(user[bi]), &ibm[ibi], ibi);
	      } else if (ibi<6) {
		ibm_search_thin(&(user[bi]), &ibm[ibi], ibi); // search 
	      }
	    
	    }else if(Pipe){
	      
	      PetscPrintf(PETSC_COMM_WORLD, "IBM_Search rev for pipe %d %d\n", ibi,bi);
	      ibm_search_advanced_rev(&(user[bi]), &ibm[ibi], ibi);
	      
	    }else {
	      PetscPrintf(PETSC_COMM_WORLD, "IBM_SERA ibi %d bi %d\n", ibi, bi);
	      ibm_search_advanced(&(user[bi]), &ibm[ibi], ibi);
	      
	    }
	  }
	} //ibi
	PetscBarrier(PETSC_NULL);
	for (ibi=0;ibi<NumberOfBodies;ibi++) {
	  PetscPrintf(PETSC_COMM_WORLD, "IBM_INTP\n");
	  ibm_interpolation_advanced(&user[bi], &ibm[ibi], ibi, 1);
	  PetscPrintf(PETSC_COMM_WORLD, "IBM_INTP End\n");
	  
	}
      }
    }
  }
  
  ti = 0;
  if (rstart_flg) ti = tistart;

  if (ti==0) {
    if (InitialGuessOne) {
      for (bi=0; bi<block_number; bi++) {
	SetInitialGuessToOne(&(user[bi]));
	InflowFlux(&(user[bi]));
	OutflowFlux(&(user[bi]));
	FormBCS(&(user[bi]));
	if (wallfunction) {
	  InflowFlux(&(user[bi]));
	  FormBCS(&(user[bi]));
	}
      }
      if (block_number>1) {
	Block_Interface_U(user);
      }
      
      for (bi=0; bi<block_number; bi++) {
	
	if (Pipe){
	  ibi=0;
	  ibm_search_advanced_rev(&(user[bi]), &ibm[ibi], ibi);
	  ibm_interpolation_advanced(&user[bi], &ibm[ibi], ibi, 1);
	}
	PetscReal normZ, normX, normY;
	VecStrideMax(user[bi].Ucat, 0, PETSC_NULL, &normX);
	VecStrideMax(user[bi].Ucat, 1, PETSC_NULL, &normY);
	VecStrideMax(user[bi].Ucat, 2, PETSC_NULL, &normZ);
	PetscPrintf(PETSC_COMM_WORLD, "Initial Eq 11111111111! %le %le %le\n",normX, normY, normZ);
      }
    }
  }
  
  // Copy Ucont to Ucont_o for the finest level
  for (bi=0; bi<block_number; bi++) {
    
    if (block_number>1) {
      user[bi].FluxIntfcSum=0.;
      user[bi].AreaIntfcSum=0.;
    }
    
    if (inletprofile==5)
      InletRead(&user[bi]);

    if (rotateframe) {
      Cmpnts a_c; // axis of frame rotation
      // if you change this also change it in solvers.c!!!
      a_c.x=0.;
      a_c.y=0.;
      a_c.z=0.;
      
      FormAreaMoment(&user[bi], a_c);
      MomentAreaDivergence(&user[bi]);
    }
    
    if (InitialGuessOne==4){//Mohsen Sep 2012
      VecCopy(user[bi].Ucont, user[bi].Ucont_o);
      VecSet(user[bi].Ucont_rm1,0.0);
      VecAXPY(user[bi].Ucont_rm1,exp(2.0*user->dt/user->ren),user[bi].Ucont_o);
      
    } else {
      VecCopy(user[bi].Ucont, user[bi].Ucont_o);
      VecCopy(user[bi].Ucont, user[bi].Ucont_rm1);
      VecCopy(user[bi].Ucat, user[bi].Ucat_o);
      VecCopy(user[bi].P, user[bi].P_o);
    }
    
    DMGlobalToLocalBegin(user[bi].fda, user[bi].Ucont, INSERT_VALUES, user[bi].lUcont);
    DMGlobalToLocalEnd(user[bi].fda, user[bi].Ucont, INSERT_VALUES, user[bi].lUcont);
    
    DMGlobalToLocalBegin(user[bi].fda, user[bi].Ucont_o, INSERT_VALUES, user[bi].lUcont_o);
    DMGlobalToLocalEnd(user[bi].fda, user[bi].Ucont_o, INSERT_VALUES, user[bi].lUcont_o);
    
    DMGlobalToLocalBegin(user[bi].fda, user[bi].Ucont_rm1, INSERT_VALUES, user[bi].lUcont_rm1);
    DMGlobalToLocalEnd(user[bi].fda, user[bi].Ucont_rm1, INSERT_VALUES, user[bi].lUcont_rm1);
  }
  
  PetscInt tisteps = 5;
  PetscOptionsGetInt(PETSC_NULL, "-totalsteps", &tisteps, &flg);
  
  if (tistart==0) tisteps ++;
  /*  put the time accuracy coefficient 1 for the 1st real-time step */
  /*   COEF_TIME_ACCURACY=1.; */ 
  /* ==================================================================================             */
  /*   physical time Step Loop */
  
  double psum[97]; double plsum[97]; double pu17sum[97]; double pl17sum[97]; double pu24sum[97]; double pl24sum[97]; double puavesum[97]; double plavesum[97];
  for (i=0;i<97;i++) { 
    psum[i]=0.; plsum[i]=0.; pu17sum[i]=0.; pl17sum[i]=0.; pu24sum[i]=0.; pl24sum[i]=0.;puavesum[i]=0.; plavesum[i]=0.;
  }
  for (ti = tistart; ti<tistart + tisteps; ti++) {
    
    PetscPrintf(PETSC_COMM_WORLD, "Time %d\n", ti);
    
    if (inletprofile==3) { 
      fluxin(&(usermg.mgctx[usermg.mglevels-1].user[0])); //for inflow.dat of 860 ms and cycle of 2500 tisteps
    } 
    /* ==================================================================================             */
    /*     Strong-Coupling (SC) Loop */
    DoSCLoop= PETSC_TRUE ; itr_sc = 0;
    while (DoSCLoop) {
      
      itr_sc++;
      PetscPrintf(PETSC_COMM_WORLD, "SC LOOP itr # %d\n", itr_sc);
      
      //Structral Solver!
      if (immersed && !turbine)
      	Struc_Solver(&usermg,ibm,fsi,&cstart, itr_sc,tistart, &DoSCLoop, fem);
      else
	DoSCLoop = PETSC_FALSE;
      
      if (rheology){
	
	bi=0;
	
	PetscInt particle_added=0,particle_subtracted=0,*X,*Z;
	
	X=(PetscInt *)calloc(NumberOfBodies,sizeof(PetscInt));
	Z=(PetscInt *)calloc(NumberOfBodies,sizeof(PetscInt));
	
	Particle_Duplicate_Indentify (&user[bi],ibm, fsi,X,Z);
	
	for (ibi=0; ibi< NumberOfBodies; ibi++){
	  if (X[ibi]==1 || X[ibi]==2 || Z[ibi]==1 || Z[ibi]==2){
	    particle_added++;
	    user[bi].ibmlist = (IBMList *)realloc(user[bi].ibmlist,(NumberOfBodies+particle_added)*sizeof(IBMList));
	    InitIBMList(&(user[bi].ibmlist[NumberOfBodies+particle_added-1]));
	    ibm=(IBMNodes *)realloc(ibm,(NumberOfBodies+particle_added)*sizeof(IBMNodes));
	    fsi=(FSInfo *)realloc(fsi,(NumberOfBodies+particle_added)*sizeof(FSInfo));
	    FsiInitialize(0, &fsi[NumberOfBodies+particle_added-1],NumberOfBodies+particle_added-1);
	    Particle_Clone (&ibm[NumberOfBodies+particle_added-1], &fsi[NumberOfBodies+particle_added-1],&ibm[ibi],&fsi[ibi],X[ibi],Z[ibi],user[bi].dt,ibi);
	    
	    ibm_search_advanced(&(user[bi]), &ibm[NumberOfBodies+particle_added-1],NumberOfBodies+particle_added-1);
	    if (ti == (ti/tiout)*tiout)  ibm_surface_VTKOut(&ibm[NumberOfBodies+particle_added-1],NumberOfBodies+particle_added-1,ti);
	  }else if ( X[ibi]==3 || Z[ibi]==3){
	    particle_subtracted++;
	    
	    user[bi].ibmlist = (IBMList *)realloc(user[bi].ibmlist,(NumberOfBodies-particle_subtracted)*sizeof(IBMList));
	    ibm=(IBMNodes *)realloc(ibm,(NumberOfBodies+particle_subtracted)*sizeof(IBMNodes));
	    fsi=(FSInfo *)realloc(fsi,(NumberOfBodies+particle_subtracted)*sizeof(FSInfo));
	    
	  }
	  
	}
	
	NumberOfBodies = NumberOfBodies+particle_added-particle_subtracted;
	if (particle_added || particle_subtracted)  PetscPrintf(PETSC_COMM_WORLD, "Total number of particles %d \n", NumberOfBodies);
	
	free(X);
	free(Z);
	
      }//reology     
      
      /*     Flow Solver! */
      Flow_Solver(&usermg, ibm, fsi);
    }// End of while SC loop
    /* ==================================================================================             */
    /*  put the time accuracy coefficient back to 1.5
	after the 1st real-time step */
    /*     COEF_TIME_ACCURACY=1.5; */
    
    if (rheology){
      bi=0;
      Viscosity(&(usermg.mgctx[usermg.mglevels-1].user[bi]),fsi,ibm);
    }
            
    /* ==================================================================================             */
    /*     Save the old values (at ti) for later */
        
    level = usermg.mglevels-1;
    user = usermg.mgctx[level].user;
    for (bi=0; bi<block_number; bi++) {
      
      if (immersed) {
	VecCopy(user[bi].Nvert, user[bi].Nvert_o);
	DMGlobalToLocalBegin(user[bi].da, user[bi].Nvert_o, INSERT_VALUES, user[bi].lNvert_o);
	DMGlobalToLocalEnd(user[bi].da, user[bi].Nvert_o, INSERT_VALUES, user[bi].lNvert_o);
      }
            
      // Copy Ucont to Ucont_o for the finest level
      VecCopy(user[bi].Ucat, user[bi].Ucat_o);
      
      VecCopy(user[bi].Ucont_o, user[bi].Ucont_rm1);
      VecCopy(user[bi].Ucont, user[bi].Ucont_o);
      VecCopy(user[bi].P, user[bi].P_o);
      
      DMGlobalToLocalBegin(user[bi].fda, user[bi].Ucont_o, INSERT_VALUES, user[bi].lUcont_o);
      DMGlobalToLocalEnd(user[bi].fda, user[bi].Ucont_o, INSERT_VALUES, user[bi].lUcont_o);
      
      DMGlobalToLocalBegin(user[bi].fda, user[bi].Ucont_rm1, INSERT_VALUES, user[bi].lUcont_rm1);
      DMGlobalToLocalEnd(user[bi].fda, user[bi].Ucont_rm1, INSERT_VALUES, user[bi].lUcont_rm1);
      
      if (rans) {
	VecCopy(user[bi].K_Omega, user[bi].K_Omega_o);
	
	DMGlobalToLocalBegin(user[bi].fda2, user[bi].K_Omega_o, INSERT_VALUES, user[bi].lK_Omega_o);
	DMGlobalToLocalEnd(user[bi].fda2, user[bi].K_Omega_o, INSERT_VALUES, user[bi].lK_Omega_o);       
      }
    } // for bi    
    
    if (immersed) {
      
      for (ibi=0;ibi<NumberOfBodies;ibi++) {
	
	for (i=0; i<ibm[ibi].n_v; i++) {
	  ibm[ibi].x_bp_o[i] = ibm[ibi].x_bp[i];
	  ibm[ibi].y_bp_o[i] = ibm[ibi].y_bp[i];
	  ibm[ibi].z_bp_o[i] = ibm[ibi].z_bp[i];
	  
	  ibm[ibi].urm1[i].x = ibm[ibi].uold[i].x;
	  ibm[ibi].urm1[i].y = ibm[ibi].uold[i].y;
	  ibm[ibi].urm1[i].z = ibm[ibi].uold[i].z;
	  
	  ibm[ibi].uold[i].x = ibm[ibi].u[i].x;
	  ibm[ibi].uold[i].y = ibm[ibi].u[i].y;
	  ibm[ibi].uold[i].z = ibm[ibi].u[i].z;
	}
	
	for (i=0;i<6;i++){
	  fsi[ibi].S_realm1[i]=fsi[ibi].S_real[i];
	  fsi[ibi].S_real[i]=fsi[ibi].S_new[i];
	  
	  fsi[ibi].S_ang_rm1[i]=fsi[ibi].S_ang_r[i];
	  fsi[ibi].S_ang_r[i]=fsi[ibi].S_ang_n[i];
	}
	
	for (i=0;i<3;i++){
	  fsi[ibi].L_r[i]=fsi[ibi].L_n[i];
	}
	for (i=0;i<4;i++){
	  fsi[ibi].q_r[i]=fsi[ibi].q[i];
	}
	
	fsi[ibi].F_x_real=fsi[ibi].F_x;
	fsi[ibi].F_y_real=fsi[ibi].F_y;
	fsi[ibi].F_z_real=fsi[ibi].F_z;
	
	fsi[ibi].M_x_rm3=fsi[ibi].M_x_rm2;
	fsi[ibi].M_y_rm3=fsi[ibi].M_y_rm2;
	fsi[ibi].M_z_rm3=fsi[ibi].M_z_rm2;
	
	fsi[ibi].M_x_rm2=fsi[ibi].M_x_real;
	fsi[ibi].M_y_rm2=fsi[ibi].M_y_real;
	fsi[ibi].M_z_rm2=fsi[ibi].M_z_real;
	
	fsi[ibi].M_x_real=fsi[ibi].M_x;
	fsi[ibi].M_y_real=fsi[ibi].M_y;
	fsi[ibi].M_z_real=fsi[ibi].M_z;		
	
      } //ibi
    } // if immersed
    
    /* ==================================================================================             */
    
  } // ti (physical time) loop
  /* ==================================================================================             */
  //  nextp:   PetscPrintf(PETSC_COMM_WORLD, "Number of iteration is  %d \n",ti);
  
  MG_Finalize(&usermg);
  if (BHV) {fem_Finalize(fem);}
  PetscFinalize();
  
  /* ==================================================================================             */
  return(0); 
}
